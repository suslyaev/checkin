{% extends "admin/base_site.html" %}
{% load static %}

{% block extrahead %}
  {{ block.super }}
  <!-- Tabulator CSS -->
  <link href="https://unpkg.com/tabulator-tables@5.5/dist/css/tabulator.min.css" rel="stylesheet">
  
  <style>
    .guests-container {
      padding: 20px;
      max-width: 100%;
    }
    
    .guests-header {
      margin-bottom: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 15px;
    }
    
    .guests-header h2 {
      margin: 0;
      color: #333;
    }
    
    .action-buttons {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    
    .btn {
      padding: 10px 15px;
      border-radius: 4px;
      text-decoration: none;
      border: none;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      transition: all 0.3s;
    }
    
    .btn:hover {
      opacity: 0.9;
      transform: translateY(-1px);
    }
    
    .btn-primary {
      background: #417690;
      color: white;
    }
    
    .btn-success {
      background: #28a745;
      color: white;
    }
    
    .btn-secondary {
      background: #6c757d;
      color: white;
    }
    
    .btn-danger {
      background: #dc3545;
      color: white;
      padding: 5px 10px;
      font-size: 12px;
    }
    
    #guests-table {
      font-size: 14px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    
    .save-indicator {
      display: none;
      padding: 12px 20px;
      background: #d4edda;
      border: 1px solid #c3e6cb;
      color: #155724;
      border-radius: 4px;
      margin-bottom: 15px;
      font-weight: 500;
    }
    
    .save-indicator.show {
      display: block;
      animation: fadeIn 0.3s;
    }
    
    .save-indicator.error {
      background: #f8d7da;
      border-color: #f5c6cb;
      color: #721c24;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    /* –°—Ç–∏–ª–∏ –¥–ª—è Tabulator */
    .tabulator-row.tabulator-row-even {
      background-color: #f9f9f9;
    }
    
    .tabulator-row:hover {
      background-color: #e8f4f8 !important;
    }
    
    .tabulator-cell {
      padding: 8px;
    }
    
    .tabulator-header {
      background-color: #417690;
      color: white;
      font-weight: 600;
    }
    
    .tabulator-header .tabulator-col {
      border-right: 1px solid rgba(255,255,255,0.2);
    }
    
    .tabulator-header-filter input {
      background: white;
      border: 1px solid #ddd;
      padding: 4px 8px;
      border-radius: 3px;
    }
    
    /* –°—Ç–∞—Ç—É—Å—ã —Å —Ü–≤–µ—Ç–∞–º–∏ */
    .status-announced { color: #6c757d; }
    .status-invited { color: #007bff; }
    .status-registered { color: #28a745; }
    .status-visited { color: #6610f2; }
    .status-cancelled { color: #dc3545; }
    
    /* –ò–∫–æ–Ω–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è */
    .btn-delete-icon:hover {
      transform: scale(1.2);
      transition: transform 0.2s;
    }
    
    .info-panel {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 4px;
      margin-bottom: 15px;
      display: flex;
      gap: 30px;
      flex-wrap: wrap;
    }
    
    .info-item {
      display: flex;
      flex-direction: column;
    }
    
    .info-item-label {
      font-size: 12px;
      color: #6c757d;
      margin-bottom: 5px;
    }
    
    .info-item-value {
      font-size: 18px;
      font-weight: 600;
      color: #333;
    }
  </style>
{% endblock %}

{% block content %}
<div class="guests-container">
  <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∏ –∫–Ω–æ–ø–∫–∏ -->
  <div class="guests-header">
    <div>
      <h2>üìä –°–ø–∏—Å–æ–∫ –≥–æ—Å—Ç–µ–π: {{ event.name }}</h2>
      <p style="color: #6c757d; margin: 5px 0 0 0;">
        –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ —Å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º –≤ —è—á–µ–π–∫–∞—Ö
      </p>
    </div>
    <div class="action-buttons">
      <button id="download-csv" class="btn btn-secondary">üì• –°–∫–∞—á–∞—Ç—å CSV</button>
      <button id="reload-data" class="btn btn-primary">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
      <a href="{% url 'admin:event_moduleinstance_change' event.id %}" class="btn btn-secondary">‚Üê –ù–∞–∑–∞–¥</a>
    </div>
  </div>
  
  <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–∞—è –ø–∞–Ω–µ–ª—å -->
  <div class="info-panel">
    <div class="info-item">
      <span class="info-item-label">–í—Å–µ–≥–æ –≥–æ—Å—Ç–µ–π</span>
      <span class="info-item-value" id="total-count">0</span>
    </div>
    <div class="info-item">
      <span class="info-item-label">–ó–∞—è–≤–ª–µ–Ω–æ</span>
      <span class="info-item-value status-announced" id="announced-count">0</span>
    </div>
    <div class="info-item">
      <span class="info-item-label">–ü—Ä–∏–≥–ª–∞—à–µ–Ω–æ</span>
      <span class="info-item-value status-invited" id="invited-count">0</span>
    </div>
    <div class="info-item">
      <span class="info-item-label">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ</span>
      <span class="info-item-value status-registered" id="registered-count">0</span>
    </div>
    <div class="info-item">
      <span class="info-item-label">–ü–æ—Å–µ—Ç–∏–ª–æ</span>
      <span class="info-item-value status-visited" id="visited-count">0</span>
    </div>
  </div>
  
  <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è -->
  <div id="save-indicator" class="save-indicator"></div>
  
  <!-- –ö–Ω–æ–ø–∫–∏ –Ω–∞–¥ —Ç–∞–±–ª–∏—Ü–µ–π -->
  <div style="margin-bottom: 15px; display: flex; gap: 15px; align-items: center;">
    <button id="add-row" class="btn btn-success">+ –î–æ–±–∞–≤–∏—Ç—å –≥–æ—Å—Ç—è</button>
    <div style="color: #6c757d; font-size: 13px;">
      –ö–ª–∏–∫ –Ω–∞ —è—á–µ–π–∫—É –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è | üë§ - –æ—Ç–∫—Ä—ã—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É | üóëÔ∏è - —É–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å
    </div>
  </div>
  
  <!-- –¢–∞–±–ª–∏—Ü–∞ -->
  <div id="guests-table"></div>
</div>

<!-- Tabulator JS -->
<script src="https://unpkg.com/tabulator-tables@5.5/dist/js/tabulator.min.js"></script>

<script>
// ==================== –ù–ê–°–¢–†–û–ô–ö–ò ====================

// –ü–æ–ª—É—á–∞–µ–º CSRF —Ç–æ–∫–µ–Ω
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}

const csrftoken = getCookie('csrftoken');
const eventId = {{ event.id }};

// –û–ø—Ü–∏–∏ –¥–ª—è —Å—Ç–∞—Ç—É—Å–æ–≤
const statusOptions = {
  'announced': '–ó–∞—è–≤–ª–µ–Ω',
  'invited': '–ü—Ä–∏–≥–ª–∞—à—ë–Ω',
  'registered': '–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω',
  'visited': '–ü–æ—Å–µ—Ç–∏–ª',
  'cancelled': '–û—Ç–∫–ª–æ–Ω–∏–ª'
};

// ==================== –§–£–ù–ö–¶–ò–ò (–æ–±—ä—è–≤–ª—è–µ–º –î–û –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Ç–∞–±–ª–∏—Ü—ã) ====================

// –ö—ç—à –¥–ª—è –∞–≤—Ç–æ–∫–æ–º–ø–ª–∏—Ç–∞
const autocompleteCache = {
  company: [],
  category: [],
  type_guest: [],
  producer: []
};

// –•—Ä–∞–Ω–∏–ª–∏—â–µ —Ç–∞–π–º–µ—Ä–æ–≤ –¥–ª—è debounce —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
const saveTimers = {};

// –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–æ–≤ –¥–ª—è –∞–≤—Ç–æ–∫–æ–º–ø–ª–∏—Ç–∞
function loadAutocompleteData(field) {
  const url = `/admin/event/moduleinstance/${eventId}/autocomplete/${field}/`;
  console.log(`–ó–∞–≥—Ä—É–∑–∫–∞ –∞–≤—Ç–æ–∫–æ–º–ø–ª–∏—Ç–∞ –¥–ª—è ${field} –∏–∑ ${url}`);
  
  return fetch(url, {
    headers: {
      'X-CSRFToken': csrftoken
    }
  })
  .then(response => {
    console.log(`–û—Ç–≤–µ—Ç –¥–ª—è ${field}:`, response.status, response.statusText);
    if (!response.ok) {
      return response.text().then(text => {
        console.error(`–û—à–∏–±–∫–∞ ${response.status} –¥–ª—è ${field}:`, text);
        throw new Error(`HTTP ${response.status}: ${text.substring(0, 200)}`);
      });
    }
    return response.json();
  })
  .then(data => {
    console.log(`–î–∞–Ω–Ω—ã–µ –¥–ª—è ${field}:`, data);
    autocompleteCache[field] = data.results || [];
    return autocompleteCache[field];
  })
  .catch(error => {
    console.error(`Error loading autocomplete for ${field}:`, error);
    // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤, —á—Ç–æ–±—ã –Ω–µ –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –æ—Å—Ç–∞–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å
    autocompleteCache[field] = [];
    return [];
  });
}

// –°–æ–∑–¥–∞–Ω–∏–µ autocomplete —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞
function createAutocompleteEditor(field) {
  console.log(`–°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ –¥–ª—è –ø–æ–ª—è: ${field}`);
  return function(cell, onRendered, success, cancel) {
    console.log(`–†–µ–¥–∞–∫—Ç–æ—Ä –æ—Ç–∫—Ä—ã—Ç –¥–ª—è –ø–æ–ª—è ${field}, —Ç–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ:`, cell.getValue());
    
    const input = document.createElement("input");
    input.type = "text";
    input.value = cell.getValue() || "";
    input.style.width = "100%";
    input.style.padding = "4px";
    input.style.boxSizing = "border-box";
    
    const listDiv = document.createElement("div");
    listDiv.style.position = "absolute";
    listDiv.style.background = "white";
    listDiv.style.border = "1px solid #ddd";
    listDiv.style.maxHeight = "200px";
    listDiv.style.overflowY = "auto";
    listDiv.style.zIndex = "1000";
    listDiv.style.width = cell.getElement().offsetWidth + "px";
    listDiv.style.display = "none";
    
    function showList(items, inputValue) {
      listDiv.innerHTML = "";
      
      // –î–æ–±–∞–≤–ª—è–µ–º –æ–ø—Ü–∏—é "–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π"
      if (inputValue) {
        const createItem = document.createElement("div");
        createItem.style.padding = "8px";
        createItem.style.cursor = "pointer";
        createItem.style.background = "#e8f4f8";
        createItem.style.borderBottom = "1px solid #ddd";
        createItem.style.fontWeight = "bold";
        createItem.textContent = `‚ûï –°–æ–∑–¥–∞—Ç—å "${inputValue}"`;
        createItem.onclick = function() {
          console.log(`–í—ã–±—Ä–∞–Ω–æ "–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π" –¥–ª—è ${field}:`, inputValue);
          success(inputValue);
          listDiv.style.display = "none";
          
          // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞
          setTimeout(() => {
            console.log('–í—ã–∑—ã–≤–∞–µ–º saveRow –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ');
            saveRow(cell.getRow());
          }, 100);
        };
        listDiv.appendChild(createItem);
      }
      
      // –î–æ–±–∞–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —ç–ª–µ–º–µ–Ω—Ç—ã
      items.forEach(item => {
        const div = document.createElement("div");
        div.style.padding = "8px";
        div.style.cursor = "pointer";
        div.textContent = item.name;
        div.onmouseover = function() {
          this.style.background = "#f0f0f0";
        };
        div.onmouseout = function() {
          this.style.background = "white";
        };
        div.onclick = function() {
          console.log(`–í—ã–±—Ä–∞–Ω —ç–ª–µ–º–µ–Ω—Ç –¥–ª—è ${field}:`, item.name);
          success(item.name);
          listDiv.style.display = "none";
          
          // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞
          setTimeout(() => {
            console.log('–í—ã–∑—ã–≤–∞–µ–º saveRow –ø–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ –∏–∑ —Å–ø–∏—Å–∫–∞');
            saveRow(cell.getRow());
          }, 100);
        };
        listDiv.appendChild(div);
      });
      
      listDiv.style.display = items.length > 0 || inputValue ? "block" : "none";
    }
    
    input.addEventListener("focus", function() {
      loadAutocompleteData(field).then(items => {
        showList(items, input.value);
      });
    });
    
    input.addEventListener("input", function() {
      const value = input.value.toLowerCase();
      const filtered = autocompleteCache[field].filter(item => 
        item.name.toLowerCase().includes(value)
      );
      showList(filtered, input.value);
    });
    
    input.addEventListener("blur", function() {
      setTimeout(() => {
        listDiv.style.display = "none";
        const newValue = input.value;
        console.log(`Blur –Ω–∞ –ø–æ–ª–µ ${field}, —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ:`, newValue);
        success(newValue);
        
        // –¢—Ä–∏–≥–≥–µ—Ä–∏–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤—Ä—É—á–Ω—É—é
        setTimeout(() => {
          console.log('–í—ã–∑—ã–≤–∞–µ–º saveRow –∏–∑ blur —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞');
          saveRow(cell.getRow());
        }, 100);
      }, 200);
    });
    
    input.addEventListener("keydown", function(e) {
      if (e.key === "Enter") {
        const newValue = input.value;
        console.log(`Enter –Ω–∞ –ø–æ–ª–µ ${field}, —Å–æ—Ö—Ä–∞–Ω—è–µ–º:`, newValue);
        success(newValue);
        listDiv.style.display = "none";
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ—Å–ª–µ Enter
        setTimeout(() => {
          console.log('–í—ã–∑—ã–≤–∞–µ–º saveRow –ø–æ—Å–ª–µ Enter');
          saveRow(cell.getRow());
        }, 100);
      } else if (e.key === "Escape") {
        console.log(`Escape –Ω–∞ –ø–æ–ª–µ ${field}, –æ—Ç–º–µ–Ω—è–µ–º`);
        cancel();
        listDiv.style.display = "none";
      }
    });
    
    onRendered(function() {
      input.focus();
      input.select();
      cell.getElement().style.position = "relative";
      cell.getElement().appendChild(listDiv);
    });
    
    return input;
  };
}

// ==================== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –¢–ê–ë–õ–ò–¶–´ ====================

// –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ –≤—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã
console.log('–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ—É–Ω–∫—Ü–∏–π –ø–µ—Ä–µ–¥ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–µ–π —Ç–∞–±–ª–∏—Ü—ã:');
console.log('- createAutocompleteEditor:', typeof createAutocompleteEditor);
console.log('- loadAutocompleteData:', typeof loadAutocompleteData);
console.log('- Test editor –¥–ª—è company:', typeof createAutocompleteEditor('company'));

const table = new Tabulator("#guests-table", {
  height: "600px",
  layout: "fitDataStretch",
  placeholder: "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö. –ù–∞–∂–º–∏—Ç–µ '+ –î–æ–±–∞–≤–∏—Ç—å –≥–æ—Å—Ç—è' –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø–µ—Ä–≤–æ–π –∑–∞–ø–∏—Å–∏.",
  resizableColumns: true,
  
  // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
  ajaxURL: "{% url 'admin:event_guests_data' event.id %}",
  ajaxConfig: {
    headers: {
      'X-CSRFToken': csrftoken
    }
  },
  ajaxResponse: function(url, params, response) {
    updateStats(response.data);
    return response.data;
  },
  
  // –ö–æ–ª–æ–Ω–∫–∏
  columns: [
    {
      title: "ID", 
      field: "id", 
      visible: false
    },
    {
      title: "", 
      field: "contact_id",
      formatter: function(cell) {
        const contactId = cell.getValue();
        const rowData = cell.getRow().getData();
        const guestName = `${rowData.last_name} ${rowData.first_name}`;
        
        let html = '';
        
        // –ò–∫–æ–Ω–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è –∫–∞—Ä—Ç–æ—á–∫–∏
        if (contactId) {
          const url = `/admin/event/contact/${contactId}/change/`;
          html += `<a href="${url}" target="_blank" title="–û—Ç–∫—Ä—ã—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É —á–µ–ª–æ–≤–µ–∫–∞" style="color: #417690; font-size: 16px; text-decoration: none; margin-right: 5px;">üë§</a>`;
        }
        
        // –ò–∫–æ–Ω–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è
        html += `<span class="btn-delete-icon" title="–£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å" style="color: #dc3545; font-size: 14px; cursor: pointer; user-select: none;">üóëÔ∏è</span>`;
        
        return html;
      },
      width: 70,
      hozAlign: "center",
      headerSort: false,
      cellClick: function(e, cell) {
        // –ï—Å–ª–∏ –∫–ª–∏–∫ –ø–æ –∏–∫–æ–Ω–∫–µ —É–¥–∞–ª–µ–Ω–∏—è
        if (e.target.classList.contains('btn-delete-icon') || e.target.textContent === 'üóëÔ∏è') {
          e.stopPropagation();
          const rowData = cell.getRow().getData();
          if (confirm(`–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞–ø–∏—Å—å?\n\n–ì–æ—Å—Ç—å: ${rowData.last_name} ${rowData.first_name}`)) {
            deleteRow(cell.getRow());
          }
        }
        // –ï—Å–ª–∏ –∫–ª–∏–∫ –ø–æ —Å—Å—ã–ª–∫–µ –Ω–∞ —á–µ–ª–æ–≤–µ–∫–∞ - –Ω–µ –º–µ—à–∞–µ–º
      }
    },
    {
      title: "–§–∞–º–∏–ª–∏—è", 
      field: "last_name", 
      editor: "input", 
      width: 150, 
      headerFilter: "input",
      validator: "required",
      cellEdited: function(cell) {
        console.log('–§–∞–º–∏–ª–∏—è –∏–∑–º–µ–Ω–µ–Ω–∞:', cell.getValue());
        triggerSave(cell.getRow());
      }
    },
    {
      title: "–ò–º—è", 
      field: "first_name", 
      editor: "input", 
      width: 130, 
      headerFilter: "input",
      validator: "required",
      cellEdited: function(cell) {
        console.log('–ò–º—è –∏–∑–º–µ–Ω–µ–Ω–æ:', cell.getValue());
        triggerSave(cell.getRow());
      }
    },
    {
      title: "–û—Ç—á–µ—Å—Ç–≤–æ", 
      field: "middle_name", 
      editor: "input", 
      width: 150, 
      headerFilter: "input",
      cellEdited: function(cell) {
        console.log('–û—Ç—á–µ—Å—Ç–≤–æ –∏–∑–º–µ–Ω–µ–Ω–æ:', cell.getValue());
        triggerSave(cell.getRow());
      }
    },
    {
      title: "–ù–∏–∫–Ω–µ–π–º", 
      field: "nickname", 
      editor: "input", 
      width: 130, 
      headerFilter: "input",
      cellEdited: function(cell) {
        console.log('–ù–∏–∫–Ω–µ–π–º –∏–∑–º–µ–Ω–µ–Ω:', cell.getValue());
        triggerSave(cell.getRow());
      }
    },
    {
      title: "–ö–æ–º–ø–∞–Ω–∏—è", 
      field: "company", 
      editor: createAutocompleteEditor('company'),
      width: 150, 
      headerFilter: "input"
    },
    {
      title: "–ö–∞—Ç–µ–≥–æ—Ä–∏—è", 
      field: "category", 
      editor: createAutocompleteEditor('category'),
      width: 130, 
      headerFilter: "input"
    },
    {
      title: "–¢–∏–ø –≥–æ—Å—Ç—è", 
      field: "type_guest", 
      editor: createAutocompleteEditor('type_guest'),
      width: 130, 
      headerFilter: "input"
    },
    {
      title: "–ü—Ä–æ–¥—é—Å–µ—Ä", 
      field: "producer", 
      editor: createAutocompleteEditor('producer'),
      width: 150, 
      headerFilter: "input"
    },
    {
      title: "–°—Ç–∞—Ç—É—Å", 
      field: "action_type", 
      editor: "list",
      editorParams: {
        values: statusOptions,
        clearable: false
      },
      formatter: function(cell) {
        const value = cell.getValue();
        const text = statusOptions[value] || value;
        return '<span class="status-' + value + '">' + text + '</span>';
      },
      width: 150,
      headerFilter: "list",
      headerFilterParams: {values: statusOptions},
      cellEdited: function(cell) {
        console.log('–°—Ç–∞—Ç—É—Å –∏–∑–º–µ–Ω–µ–Ω:', cell.getValue());
        triggerSave(cell.getRow());
      }
    },
    {
      title: "–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π", 
      field: "comment", 
      editor: "input", 
      width: 200,
      cellEdited: function(cell) {
        console.log('–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∏–∑–º–µ–Ω–µ–Ω:', cell.getValue());
        triggerSave(cell.getRow());
      }
    }
  ]
});

// ==================== –û–°–¢–ê–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ====================

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ç—Ä–∏–≥–≥–µ—Ä–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å debounce
function triggerSave(row) {
  const rowData = row.getData();
  const rowId = rowData.id || 'new_' + Date.now(); // ID —Å—Ç—Ä–æ–∫–∏ –¥–ª—è —Ç–∞–π–º–µ—Ä–∞
  
  console.log('triggerSave –≤—ã–∑–≤–∞–Ω –¥–ª—è —Å—Ç—Ä–æ–∫–∏ —Å ID:', rowId);
  
  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —á—Ç–æ –∏–¥–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
  showIndicator('üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...', 'saving');
  
  // –û—Ç–º–µ–Ω—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Ç–∞–π–º–µ—Ä –µ—Å–ª–∏ –µ—Å—Ç—å
  if (saveTimers[rowId]) {
    clearTimeout(saveTimers[rowId]);
    console.log('–ü—Ä–µ–¥—ã–¥—É—â–∏–π —Ç–∞–π–º–µ—Ä –æ—Ç–º–µ–Ω–µ–Ω –¥–ª—è', rowId);
  }
  
  // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π 1 —Å–µ–∫—É–Ω–¥–∞
  saveTimers[rowId] = setTimeout(() => {
    console.log('–¢–∞–π–º–µ—Ä –∏—Å—Ç–µ–∫, –≤—ã–∑—ã–≤–∞–µ–º saveRow –¥–ª—è', rowId);
    saveRow(row);
    delete saveTimers[rowId]; // –û—á–∏—â–∞–µ–º —Ç–∞–π–º–µ—Ä –ø–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
  }, 1000);
}

// –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏
function saveRow(row) {
  console.log('=== saveRow –≤—ã–∑–≤–∞–Ω ===');
  const data = row.getData();
  console.log('–î–∞–Ω–Ω—ã–µ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', data);
  
  // –í–∞–ª–∏–¥–∞—Ü–∏—è
  if (!data.last_name || !data.first_name) {
    console.error('–í–∞–ª–∏–¥–∞—Ü–∏—è –Ω–µ –ø—Ä–æ—à–ª–∞: –Ω–µ—Ç —Ñ–∞–º–∏–ª–∏–∏ –∏–ª–∏ –∏–º–µ–Ω–∏');
    showIndicator('‚ùå –û—à–∏–±–∫–∞: –§–∞–º–∏–ª–∏—è –∏ –ò–º—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã', 'error');
    return;
  }
  
  console.log('–û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä...');
  
  fetch("{% url 'admin:event_guest_save' event.id %}", {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': csrftoken
    },
    body: JSON.stringify(data)
  })
  .then(response => {
    console.log('Response status:', response.status);
    return response.json();
  })
  .then(result => {
    console.log('Result:', result);
    if (result.success) {
      // –û–±–Ω–æ–≤–ª—è–µ–º ID –µ—Å–ª–∏ —ç—Ç–æ –±—ã–ª–∞ –Ω–æ–≤–∞—è —Å—Ç—Ä–æ–∫–∞
      if (!data.id) {
        row.update({
          id: result.id, 
          contact_id: result.contact_id
        }, true);  // true = –Ω–µ —Ç—Ä–∏–≥–≥–µ—Ä–∏—Ç—å cellEdited
      }
      showIndicator('‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ: ' + data.last_name + ' ' + data.first_name, 'success');
      
      // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–∫–∏ –¥–ª—è –∞–≤—Ç–æ–∫–æ–º–ø–ª–∏—Ç–∞
      loadAutocompleteData('company');
      loadAutocompleteData('category');
      loadAutocompleteData('type_guest');
      loadAutocompleteData('producer');
      
      // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
      setTimeout(() => {
        table.replaceData();
      }, 500);
    } else {
      showIndicator('‚ùå –û—à–∏–±–∫–∞: ' + result.error, 'error');
    }
  })
  .catch(error => {
    console.error('Save error:', error);
    showIndicator('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + error, 'error');
  });
}

// –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏
function deleteRow(row) {
  const data = row.getData();
  
  if (!data.id) {
    row.delete();
    showIndicator('‚úÖ –ó–∞–ø–∏—Å—å —É–¥–∞–ª–µ–Ω–∞', 'success');
    return;
  }
  
  fetch("{% url 'admin:event_guest_delete' event.id %}", {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': csrftoken
    },
    body: JSON.stringify({id: data.id})
  })
  .then(response => response.json())
  .then(result => {
    if (result.success) {
      row.delete();
      showIndicator('‚úÖ –ó–∞–ø–∏—Å—å —É–¥–∞–ª–µ–Ω–∞', 'success');
      
      // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
      table.replaceData();
    } else {
      showIndicator('‚ùå ' + result.error, 'error');
    }
  })
  .catch(error => {
    console.error('Error:', error);
    showIndicator('‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ' + error, 'error');
  });
}

// –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
let indicatorTimeout;
function showIndicator(message, type = 'success') {
  const indicator = document.getElementById('save-indicator');
  indicator.textContent = message;
  indicator.className = 'save-indicator show';
  
  if (type === 'error') {
    indicator.classList.add('error');
  } else if (type === 'saving') {
    indicator.style.background = '#fff3cd';
    indicator.style.borderColor = '#ffeaa7';
    indicator.style.color = '#856404';
  } else {
    // success
    indicator.style.background = '#d4edda';
    indicator.style.borderColor = '#c3e6cb';
    indicator.style.color = '#155724';
  }
  
  // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Ç–∞–π–º–∞—É—Ç
  if (indicatorTimeout) {
    clearTimeout(indicatorTimeout);
  }
  
  // –î–ª—è 'saving' –Ω–µ —Å–∫—Ä—ã–≤–∞–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
  if (type !== 'saving') {
    indicatorTimeout = setTimeout(() => {
      indicator.classList.remove('show');
    }, 3000);
  }
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
function updateStats(data) {
  const stats = {
    total: data.length,
    announced: 0,
    invited: 0,
    registered: 0,
    visited: 0,
    cancelled: 0
  };
  
  data.forEach(row => {
    if (stats.hasOwnProperty(row.action_type)) {
      stats[row.action_type]++;
    }
  });
  
  document.getElementById('total-count').textContent = stats.total;
  document.getElementById('announced-count').textContent = stats.announced;
  document.getElementById('invited-count').textContent = stats.invited;
  document.getElementById('registered-count').textContent = stats.registered;
  document.getElementById('visited-count').textContent = stats.visited;
}

// ==================== –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –°–û–ë–´–¢–ò–ô ====================

// –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏
document.getElementById('add-row').addEventListener('click', function() {
  table.addRow({
    last_name: '',
    first_name: '',
    middle_name: '',
    nickname: '',
    company: '',
    category: '',
    type_guest: '',
    action_type: 'announced',
    comment: ''
  }, true);  // true = –¥–æ–±–∞–≤–∏—Ç—å –≤ –Ω–∞—á–∞–ª–æ
  
  showIndicator('–ù–æ–≤–∞—è —Å—Ç—Ä–æ–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞. –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ.', 'success');
});

// –°–∫–∞—á–∞—Ç—å CSV
document.getElementById('download-csv').addEventListener('click', function() {
  const filename = 'guests_{{ event.name|slugify }}_' + new Date().toISOString().split('T')[0] + '.csv';
  table.download("csv", filename, {delimiter: ";"});
  showIndicator('CSV —Ñ–∞–π–ª —Å–∫–∞—á–∏–≤–∞–µ—Ç—Å—è...', 'success');
});

// –û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ
document.getElementById('reload-data').addEventListener('click', function() {
  table.replaceData();
  showIndicator('–î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã', 'success');
});

// –ü—Ä–µ–¥–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–∫–∏ –¥–ª—è –∞–≤—Ç–æ–∫–æ–º–ø–ª–∏—Ç–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {
  console.log('–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–æ–≤ –¥–ª—è –∞–≤—Ç–æ–∫–æ–º–ø–ª–∏—Ç–∞...');
  loadAutocompleteData('company');
  loadAutocompleteData('category');
  loadAutocompleteData('type_guest');
  loadAutocompleteData('producer');
});
</script>

{% endblock %}

